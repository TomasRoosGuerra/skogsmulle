<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Skogsmulle - Magiska √§ventyr f√∂r barn</title>
<meta name="description" content="Uppt√§ck Skogsmulles magiska v√§rld med underbara ber√§ttelser f√∂r barn. Perfekt f√∂r f√∂r√§ldrar som vill l√§sa sagor f√∂r sina barn.">
<meta name="keywords" content="barnb√∂cker,sagor,Skogsmulle,barn,f√∂r√§ldrar,l√§sning,√§ventyr,svenska sagor">
<meta name="author" content="Tomas Roos Guerra">
<meta name="robots" content="index,follow">
<meta property="og:title" content="Skogsmulle - Magiska √§ventyr f√∂r barn">
<meta property="og:description" content="Uppt√§ck Skogsmulles magiska v√§rld med underbara ber√§ttelser f√∂r barn.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://skogsmulle.netlify.app">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Skogsmulle - Magiska √§ventyr f√∂r barn">
<meta name="twitter:description" content="Uppt√§ck Skogsmulles magiska v√§rld med underbara ber√§ttelser f√∂r barn.">
<link rel="canonical" href="https://skogsmulle.netlify.app">

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import{getFirestore,collection,addDoc,getDocs,doc,updateDoc,deleteDoc,onSnapshot,orderBy,query,serverTimestamp}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyAl4FKCAqrt_Vkw0jRddSnR1gn4BGby-rA",authDomain:"skogsmulle-c601d.firebaseapp.com",projectId:"skogsmulle-c601d",storageBucket:"skogsmulle-c601d.firebasestorage.app",messagingSenderId:"878822846379",appId:"1:878822846379:web:b545d30bab52d19a5facee",measurementId:"G-SV2RJXDS5S"};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

Object.assign(window,{
  firebaseApp:app,firebaseDb:db,firebaseCollection:collection,firebaseAddDoc:addDoc,firebaseGetDocs:getDocs,firebaseDoc:doc,firebaseUpdateDoc:updateDoc,firebaseDeleteDoc:deleteDoc,firebaseOnSnapshot:onSnapshot,firebaseOrderBy:orderBy,firebaseQuery:query,firebaseServerTimestamp:serverTimestamp
});
</script>

<style>
:root{
--p:#4a5d3a;--s:#2d3a2d;--a:#6a7a5a;--bg:#f5f4e8;--txt:#3d4a2d;--w:#fff;--lg:#f0f8f0;--br:rgba(144,180,120,0.2);--sh:0 3px 12px rgba(0,0,0,0.06);--r:12px;--f:"Georgia","Times New Roman",serif;--fu:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
}

*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;font-family:var(--fu)}

body{background:var(--bg) radial-gradient(circle at 20% 80%,rgba(144,180,120,0.08) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(120,150,180,0.06) 0%,transparent 50%),radial-gradient(circle at 40% 40%,rgba(160,200,140,0.05) 0%,transparent 50%),url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><defs><filter id="watercolor"><feTurbulence baseFrequency="0.02" numOctaves="3" result="noise"/><feColorMatrix values="0 0 0 0 0.8 0 0 0 0 0.9 0 0 0 0 0.7 0 0 0 0.1 0"/></filter></defs><rect width="100" height="100" fill="%23f5f4e8" filter="url(%23watercolor)"/></svg>');background-size:200px 200px,300px 300px,250px 250px,150px 150px;color:var(--txt);line-height:1.6;font-family:var(--f)}

.skip-link{position:absolute;top:-40px;left:6px;background:var(--p);color:var(--w);padding:8px;text-decoration:none;z-index:1000;border-radius:4px}
.skip-link:focus{top:6px}

.container{max-width:1200px;margin:0 auto;padding:0 20px}

.main-header{position:relative;background:linear-gradient(135deg,rgba(144,238,144,0.4),rgba(135,206,235,0.4),rgba(152,251,152,0.3));backdrop-filter:blur(10px);border-radius:15px;margin:20px;padding:40px 20px;overflow:hidden;border:1px solid var(--br);box-shadow:var(--sh)}

.header-background{position:absolute;top:0;left:0;right:0;bottom:0;background:url("skogsmullecolor.png") center/cover;opacity:0.6;z-index:1}

.hero-section{position:relative;z-index:2;text-align:center;color:var(--txt)}

.logo{font-size:2.8rem;color:var(--p);margin-bottom:20px;text-shadow:1px 1px 2px rgba(255,255,255,0.8);font-family:var(--f);font-style:italic}

.welcome-section{margin-bottom:30px}

.magical-title{font-size:2.2rem;color:var(--p);margin-bottom:15px;text-shadow:1px 1px 2px rgba(255,255,255,0.9);font-family:var(--f);font-style:italic;animation:gentleGlow 3s ease-in-out infinite alternate}

.welcome-text{font-size:1.1rem;color:var(--txt);margin-bottom:20px;font-style:italic;max-width:600px;margin-left:auto;margin-right:auto}

.audience-buttons{display:flex;justify-content:center;gap:15px;flex-wrap:wrap;margin-top:20px}

.audience-btn{background:linear-gradient(135deg,rgba(144,238,144,0.8),rgba(135,206,235,0.8));color:var(--s);border:1px solid var(--br);border-radius:var(--r);padding:12px 24px;font-size:1rem;font-weight:normal;cursor:pointer;transition:all 0.3s ease;box-shadow:var(--sh);text-shadow:none;font-family:var(--f);text-decoration:none;display:inline-block}

.audience-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}

.parent-btn{background:linear-gradient(135deg,rgba(144,238,144,0.9),rgba(135,206,235,0.7))}

.child-btn{background:linear-gradient(135deg,rgba(135,206,235,0.9),rgba(144,238,144,0.7))}

.discrete-login{position:fixed;top:20px;right:20px;background:linear-gradient(135deg,rgba(144,238,144,0.9),rgba(135,206,235,0.7));color:var(--s);border:1px solid var(--br);border-radius:var(--r);padding:8px 16px;font-size:0.9rem;cursor:pointer;transition:all 0.3s ease;box-shadow:var(--sh);z-index:1000;font-family:var(--f)}

.discrete-login:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}

.login-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:2000}

.modal-content{background:var(--w);padding:30px;border-radius:var(--r);box-shadow:0 10px 30px rgba(0,0,0,0.3);max-width:400px;width:90%}

.modal-content h2{margin-bottom:20px;color:var(--p);font-family:var(--f)}

.form-group{margin-bottom:15px}

.form-group label{display:block;margin-bottom:5px;color:var(--s);font-weight:bold}

.form-group input{width:100%;padding:10px;border:1px solid var(--br);border-radius:6px;font-size:1rem;transition:border-color 0.3s ease}

.form-group input:focus{outline:none;border-color:var(--p);box-shadow:0 0 0 2px rgba(74,93,58,0.2)}

.modal-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}

.btn{background:linear-gradient(135deg,rgba(144,238,144,0.8),rgba(135,206,235,0.8));color:var(--s);border:1px solid var(--br);border-radius:6px;padding:10px 20px;cursor:pointer;transition:all 0.3s ease;font-family:var(--f)}

.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}

.btn-secondary{background:linear-gradient(135deg,rgba(135,206,235,0.8),rgba(144,238,144,0.8))}

.main-navigation{background:linear-gradient(135deg,rgba(144,238,144,0.9),rgba(135,206,235,0.8));backdrop-filter:blur(10px);border-radius:var(--r);margin:20px;padding:15px 20px;position:sticky;top:20px;z-index:100;border:1px solid var(--br);box-shadow:var(--sh)}

.nav-links{list-style:none;display:flex;justify-content:center;gap:30px;flex-wrap:wrap}

.nav-links a{color:var(--s);text-decoration:none;font-weight:bold;padding:8px 16px;border-radius:6px;transition:all 0.3s ease;font-family:var(--f)}

.nav-links a:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}

.content{display:grid;grid-template-columns:1fr 300px;gap:30px;margin:30px 20px}

.blog-section{background:rgba(255,255,255,0.7);backdrop-filter:blur(5px);border-radius:var(--r);padding:30px;border:1px solid var(--br);box-shadow:var(--sh)}

.blog-post{background:linear-gradient(135deg,rgba(255,255,255,0.9),rgba(240,248,240,0.8));border-radius:var(--r);padding:20px;margin-bottom:20px;border:1px solid var(--br);box-shadow:var(--sh);backdrop-filter:blur(2px);transition:all 0.3s ease;position:relative}

.blog-post::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><defs><filter id="paper"><feTurbulence baseFrequency="0.04" numOctaves="2" result="noise"/><feColorMatrix values="0 0 0 0 0.9 0 0 0 0 0.95 0 0 0 0 0.85 0 0 0 0.3 0"/></filter></defs><rect width="100" height="100" fill="white" filter="url(%23paper)"/></svg>') repeat;opacity:0.1;pointer-events:none;border-radius:var(--r)}

.blog-post:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.1)}

.post-header{margin-bottom:15px;border-bottom:1px dashed var(--br);padding-bottom:10px}

.post-title{font-size:1.4rem;color:var(--p);margin-bottom:8px;font-family:var(--f);font-style:italic}

.post-date{color:var(--a);font-size:0.85rem}

.post-content{margin-bottom:15px;color:var(--txt);line-height:1.7;font-size:1rem}

.post-actions{display:flex;gap:10px;flex-wrap:wrap}

.post-button{background:linear-gradient(135deg,rgba(144,238,144,0.8),rgba(135,206,235,0.8));color:var(--s);border:1px solid var(--br);border-radius:6px;padding:8px 16px;cursor:pointer;transition:all 0.3s ease;font-size:0.9rem;font-family:var(--f)}

.post-button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}

.sidebar{background:rgba(255,255,255,0.7);backdrop-filter:blur(5px);border-radius:var(--r);padding:20px;border:1px solid var(--br);box-shadow:var(--sh);height:fit-content}

.sidebar-widget{background:linear-gradient(135deg,rgba(255,255,255,0.9),rgba(240,248,240,0.8));border-radius:var(--r);padding:18px;margin-bottom:18px;border:1px solid var(--br);box-shadow:var(--sh);backdrop-filter:blur(2px);position:relative}

.sidebar-widget::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><defs><filter id="paper"><feTurbulence baseFrequency="0.04" numOctaves="2" result="noise"/><feColorMatrix values="0 0 0 0 0.9 0 0 0 0 0.95 0 0 0 0 0.85 0 0 0 0.3 0"/></filter></defs><rect width="100" height="100" fill="white" filter="url(%23paper)"/></svg>') repeat;opacity:0.1;pointer-events:none;border-radius:var(--r)}

.widget-title{color:var(--p);border-bottom:1px dashed var(--br);padding-bottom:8px;margin-bottom:12px;font-size:1.1rem;font-family:var(--f);font-style:italic}

.new-post-form{display:none}

.form-title{color:var(--p);margin-bottom:20px;font-size:1.3rem;font-family:var(--f);font-style:italic}

.form-group textarea{width:100%;padding:10px;border:1px solid var(--br);border-radius:6px;font-size:1rem;resize:vertical;min-height:120px;transition:border-color 0.3s ease;font-family:var(--f)}

.form-group textarea:focus{outline:none;border-color:var(--p);box-shadow:0 0 0 2px rgba(74,93,58,0.2)}

.submit-button{background:linear-gradient(135deg,rgba(144,238,144,0.9),rgba(135,206,235,0.7));color:var(--s);border:1px solid var(--br);border-radius:6px;padding:12px 24px;cursor:pointer;transition:all 0.3s ease;font-size:1rem;font-family:var(--f);width:100%}

.submit-button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}

.story-search{width:100%;padding:8px;border:1px solid var(--br);border-radius:6px;margin-bottom:10px;font-family:var(--f)}

.story-categories{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:15px}

.category-btn{background:linear-gradient(135deg,rgba(144,238,144,0.7),rgba(135,206,235,0.7));color:var(--s);border:1px solid var(--br);border-radius:6px;padding:6px 12px;cursor:pointer;transition:all 0.3s ease;font-size:0.8rem;font-family:var(--f)}

.category-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}

.character-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:10px}

.character-card{text-align:center;cursor:pointer;transition:transform 0.3s ease}

.character-card:hover{transform:scale(1.05)}

.character-icon{width:60px;height:60px;border-radius:50%;margin:0 auto 8px;background:linear-gradient(135deg,rgba(144,238,144,0.8),rgba(135,206,235,0.8));display:flex;align-items:center;justify-content:center;font-size:1.5rem;border:2px solid var(--br)}

.parent-tips{background:var(--lg);padding:15px;border-radius:var(--r);border:1px solid var(--br)}

.parent-tips h4{color:var(--p);margin-bottom:10px;font-family:var(--f)}

.parent-tips ul{list-style:none;padding-left:0}

.parent-tips li{margin-bottom:8px;padding-left:20px;position:relative;color:var(--txt)}

.parent-tips li::before{content:"üåø";position:absolute;left:0}

.author-info{background:linear-gradient(135deg,rgba(255,215,0,0.1),rgba(255,165,0,0.1));padding:15px;border-radius:var(--r);border:1px solid rgba(255,215,0,0.3);margin-bottom:15px}

.login-note{font-size:0.9rem;color:var(--a);font-style:italic;margin-top:10px}

.footer{background:linear-gradient(135deg,rgba(144,238,144,0.4),rgba(135,206,235,0.4));backdrop-filter:blur(10px);border-radius:var(--r);margin:40px 20px 20px;padding:30px;text-align:center;border:1px solid var(--br);box-shadow:var(--sh)}

.audio-player{background:linear-gradient(135deg,rgba(144,238,144,0.8),rgba(135,206,235,0.8));border-radius:var(--r);padding:15px;margin:20px;text-align:center;border:1px solid var(--br);box-shadow:var(--sh)}

.audio-player button{background:linear-gradient(135deg,rgba(255,255,255,0.9),rgba(240,248,240,0.8));color:var(--s);border:1px solid var(--br);border-radius:6px;padding:10px 20px;margin:5px;cursor:pointer;transition:all 0.3s ease;font-family:var(--f)}

.audio-player button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}

@keyframes gentleGlow{0%{text-shadow:1px 1px 2px rgba(255,255,255,0.9)}100%{text-shadow:1px 1px 8px rgba(74,93,58,0.3),1px 1px 2px rgba(255,255,255,0.9)}}

@media (max-width:1024px){.content{grid-template-columns:1fr;gap:20px}.sidebar{order:-1}}

@media (max-width:768px){.container{padding:0 15px}.main-header,.main-navigation,.content{margin:15px}.hero-section{padding:20px}.logo{font-size:2.2rem}.magical-title{font-size:1.8rem}.audience-buttons{gap:10px}.nav-links{gap:15px}.blog-section,.sidebar{padding:20px}}

@media (max-width:480px){.logo{font-size:1.8rem}.magical-title{font-size:1.5rem}.audience-btn{padding:10px 20px;font-size:0.9rem}.post-actions{justify-content:center}.character-grid{grid-template-columns:repeat(3,1fr)}}
</style>
</head>

<body>
<a href="#main-content" class="skip-link">Hoppa till huvudinneh√•ll</a>

<button class="discrete-login" onclick="toggleLoginModal()" role="button" tabindex="0" aria-label="Logga in som f√∂rfattare" onkeydown="if(event.key==='Enter') toggleLoginModal()">üîë Logga in</button>

<div id="loginModal" class="login-modal">
<div class="modal-content">
<h2>F√∂rfattarlogin</h2>
<form id="loginForm">
<div class="form-group">
<label for="emailInput">Email:</label>
<input type="email" id="emailInput" required>
</div>
<div class="modal-buttons">
<button type="submit" class="btn">Logga in</button>
<button type="button" class="btn btn-secondary" onclick="closeLoginModal()">Avbryt</button>
</div>
</form>
</div>
</div>

<header class="main-header">
<div class="header-background"></div>
<div class="hero-section">
<h1 class="logo">üå≤ Skogsmulle</h1>
<div class="welcome-section">
<h2 class="magical-title">V√§lkommen till en magisk v√§rld!</h2>
<p class="welcome-text">H√§r m√∂ter du Skogsmulle och alla hans v√§nner i underbara √§ventyr som f√•r b√•de stora och sm√• att dr√∂mma sig bort till skogens djupaste vr√•r.</p>
<div class="audience-buttons">
<button class="audience-btn parent-btn" onclick="scrollToStories()">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ F√∂r f√∂r√§ldrar</button>
<button class="audience-btn child-btn" onclick="scrollToAdventures()">üßö‚Äç‚ôÄÔ∏è F√∂r barn</button>
</div>
</div>
</div>
</header>

<nav class="main-navigation">
<ul class="nav-links">
<li><a href="#hem">üè† Hem</a></li>
<li><a href="#berattelser">üìö Ber√§ttelser</a></li>
<li><a href="#karaktarer">üé≠ Karakt√§rer</a></li>
<li><a href="#om-skogsmulle">‚ÑπÔ∏è Om Skogsmulle</a></li>
</ul>
</nav>

<main id="main-content" role="main">
<div class="content">
<section class="blog-section" aria-label="Ber√§ttelser">
<h2 style="color:var(--p);margin-bottom:20px;font-family:var(--f);font-style:italic">üìñ Ber√§ttelser</h2>
<div id="posts-container"></div>
</section>

<aside class="sidebar">
<div class="sidebar-widget">
<h3 class="widget-title">üîê F√∂rfattarverktyg</h3>
<div class="author-info">
<p><strong>Inloggad som f√∂rfattare:</strong></p>
<div id="userInfo" style="display:none">
<p id="userEmail"></p>
</div>
<div id="loginSection">
<p class="login-note">Logga in f√∂r att skapa och redigera ber√§ttelser.</p>
</div>
</div>
<form id="newPostForm" class="new-post-form">
<h3 class="form-title">Skapa ny ber√§ttelse</h3>
<div class="form-group">
<label for="postTitle">Titel:</label>
<input type="text" id="postTitle" required>
</div>
<div class="form-group">
<label for="postContent">Ber√§ttelse:</label>
<textarea id="postContent" required></textarea>
</div>
<button type="submit" class="submit-button">Publicera ber√§ttelse</button>
</form>
</div>

<div class="sidebar-widget">
<h3 class="widget-title">üìö Hitta ber√§ttelser</h3>
<input type="text" id="storySearch" class="story-search" placeholder="S√∂k efter ber√§ttelser..." aria-label="S√∂k ber√§ttelser" onkeyup="searchStories()">
<div class="story-categories">
<button class="category-btn" onclick="filterStories('all')" aria-label="Filtrera ber√§ttelser efter kategori">Alla</button>
<button class="category-btn" onclick="filterStories('adventure')">√Ñventyr</button>
<button class="category-btn" onclick="filterStories('friendship')">V√§nskap</button>
<button class="category-btn" onclick="filterStories('nature')">Natur</button>
</div>
</div>

<div class="sidebar-widget">
<h3 class="widget-title">üåü Senaste ber√§ttelserna</h3>
<div id="recentStories"></div>
</div>

<div class="sidebar-widget">
<h3 class="widget-title">üé≠ Karakt√§rer</h3>
<div class="character-grid">
<div class="character-card" onclick="showCharacterInfo('skogsmulle')">
<div class="character-icon">üå≤</div>
<div>Skogsmulle</div>
</div>
<div class="character-card" onclick="showCharacterInfo('morris')">
<div class="character-icon">ü¶°</div>
<div>Morris</div>
</div>
<div class="character-card" onclick="showCharacterInfo('evert')">
<div class="character-icon">ü¶î</div>
<div>Evert</div>
</div>
<div class="character-card" onclick="showCharacterInfo('ron')">
<div class="character-icon">ü¶ä</div>
<div>Ron</div>
</div>
</div>
</div>

<div class="sidebar-widget">
<h3 class="widget-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Tips f√∂r f√∂r√§ldrar</h3>
<div class="parent-tips">
<h4>L√§sningstips</h4>
<ul>
<li>L√§s h√∂gt varje dag</li>
<li>St√§ll fr√•gor om ber√§ttelsen</li>
<li>L√•t barnet ber√§tta om bilderna</li>
<li>Skapa egna √§ventyr tillsammans</li>
</ul>
</div>
</div>
</aside>
</div>
</main>

<div class="audio-player">
<button id="playTheme" onclick="toggleThemeAudio()" aria-label="Spela temal√•t">üéµ Spela temal√•t</button>
<button id="playAdventure" onclick="toggleAdventureAudio()" aria-label="Spela √§ventyrsl√•t">üé∂ Spela √§ventyrsl√•t</button>
</div>

<footer class="footer">
<p>&copy; 2024 Skogsmulle. Alla ber√§ttelser √§r skapade med k√§rlek f√∂r barn och f√∂r√§ldrar.</p>
</footer>

<script>
let allPosts=[],isAdmin=false,currentUser=null,themeAudio=new Audio("Skogsmulle.mp3"),adventureAudio=new Audio("telegram_audio.mp3");

const C={save:async p=>{if(!window.firebaseDb)throw new Error("Firebase not initialized");const r=window.firebaseCollection(window.firebaseDb,"posts");const d=await window.firebaseAddDoc(r,{...p,createdAt:window.firebaseServerTimestamp(),updatedAt:window.firebaseServerTimestamp()});console.log("Post saved:",d.id);return d.id},load:async()=>{if(!window.firebaseDb){allPosts=[];renderAllPosts();updateRecentStories();return}const r=window.firebaseCollection(window.firebaseDb,"posts");const q=window.firebaseQuery(r,window.firebaseOrderBy("createdAt","desc"));const s=await window.firebaseGetDocs(q);allPosts=[];s.forEach(d=>{const p=d.data();allPosts.push({id:d.id,title:p.title,content:p.content,date:p.date,timestamp:p.createdAt?.toMillis()||Date.now(),createdAt:p.createdAt,updatedAt:p.updatedAt})});console.log("Posts loaded:",allPosts.length);renderAllPosts();updateRecentStories()},update:async(id,p)=>window.firebaseUpdateDoc(window.firebaseDoc(window.firebaseDb,"posts",id),{...p,updatedAt:window.firebaseServerTimestamp()}),delete:async id=>window.firebaseDeleteDoc(window.firebaseDoc(window.firebaseDb,"posts",id))};

function setupRealtimeListener(){try{if(!window.firebaseDb){console.error("Firebase not initialized");return}const r=window.firebaseCollection(window.firebaseDb,"posts");const q=window.firebaseQuery(r,window.firebaseOrderBy("createdAt","desc"));window.firebaseOnSnapshot(q,s=>{allPosts=[];s.forEach(d=>{const p=d.data();allPosts.push({id:d.id,title:p.title,content:p.content,date:p.date,timestamp:p.createdAt?.toMillis()||Date.now(),createdAt:p.createdAt,updatedAt:p.updatedAt})});console.log("Real-time update:",allPosts.length,"posts");renderAllPosts();updateRecentStories()},e=>console.error("Real-time listener error:",e))}catch(e){console.error("Setup error:",e)}}

function renderAllPosts(){const c=document.getElementById("posts-container");if(allPosts.length===0){c.innerHTML='<p style="text-align:center;color:var(--a);font-style:italic;padding:40px">Inga ber√§ttelser √§nnu. Skapa den f√∂rsta!</p>';return}c.innerHTML=allPosts.map((p,i)=>`<article class="blog-post"><div class="post-header"><h3 class="post-title">${p.title}</h3><div class="post-date">${p.date}</div></div><div class="post-content">${p.content}</div><div class="post-actions">${isAdmin?`<button class="post-button" onclick="editPost(${i})">‚úèÔ∏è Redigera</button><button class="post-button" onclick="deletePost(${i})">üóëÔ∏è Ta bort</button>`:''}<button class="post-button" onclick="sharePost(${i})">üì§ Dela</button><button class="post-button" onclick="likePost(${i},this)">‚ù§Ô∏è Gillar</button><button class="post-button" onclick="savePost(${i},this)">üíæ Spara</button></div></article>`).join('')}

function updateRecentStories(){const c=document.getElementById("recentStories");if(allPosts.length===0){c.innerHTML='<p style="color:var(--a);font-style:italic">Inga ber√§ttelser √§nnu.</p>';return}const r=allPosts.slice(0,5);c.innerHTML=r.map(p=>`<div style="margin-bottom:10px;padding:8px;background:var(--lg);border-radius:6px;border:1px solid var(--br);cursor:pointer" onclick="scrollToStory('${p.id}')"><strong style="color:var(--p);font-size:0.9rem">${p.title}</strong><br><small style="color:var(--a)">${p.date}</small></div>`).join('')}

function scrollToPost(i){const p=document.querySelectorAll('.blog-post')[i];if(p)p.scrollIntoView({behavior:'smooth',block:'start'})}

function sharePost(i){const p=allPosts[i];if(navigator.share){navigator.share({title:p.title,text:"L√§s den h√§r underbara ber√§ttelsen fr√•n Skogsmulle!",url:window.location.href})}else{alert(`Dela ber√§ttelsen "${p.title}" med dina v√§nner!`)}}function likePost(i,b){b.textContent="‚ù§Ô∏è Gillad!";b.style.background="linear-gradient(135deg, #98FB98, #87CEEB)";b.onclick=null}function savePost(i,b){b.textContent="Sparad!";b.style.background="linear-gradient(135deg, #98FB98, #87CEEB)";b.onclick=null}

async function editPost(i){const p=allPosts[i];const t=prompt("Redigera titel:",p.title);if(t===null)return;if(!t.trim()){alert("Titel kan inte vara tom.");return}const d=document.createElement("div");d.innerHTML=p.content;const c=prompt("Redigera inneh√•ll:",d.textContent||d.innerText||"");if(c===null)return;if(!c.trim()){alert("Inneh√•ll kan inte vara tomt.");return}try{await C.update(p.id,{title:t.trim(),content:`<p>${c.trim().replace(/\n/g,"</p><p>")}</p>`,date:p.date,timestamp:p.timestamp});alert("Ber√§ttelsen har uppdaterats!")}catch(e){console.error("Update error:",e);alert("Ett fel uppstod n√§r ber√§ttelsen skulle uppdateras. F√∂rs√∂k igen.")}}

async function deletePost(i){const p=allPosts[i];if(confirm(`√Ñr du s√§ker p√• att du vill ta bort ber√§ttelsen "${p.title}"?`)){try{await C.delete(p.id);alert("Ber√§ttelsen har tagits bort!")}catch(e){console.error("Delete error:",e);alert("Ett fel uppstod n√§r ber√§ttelsen skulle tas bort. F√∂rs√∂k igen.")}}}

function searchStories(){const t=document.getElementById("storySearch").value.toLowerCase();document.querySelectorAll('.blog-post').forEach(p=>{const title=p.querySelector('.post-title').textContent.toLowerCase();const content=p.querySelector('.post-content').textContent.toLowerCase();p.style.display=title.includes(t)||content.includes(t)?'block':'none'})}

function filterStories(c){if(c==='all'){document.querySelectorAll('.blog-post').forEach(p=>p.style.display='block');return}const m={adventure:['√§ventyr','resa','utforska'],friendship:['v√§n','tillsammans','hj√§lp'],nature:['skog','tr√§d','blomma','djur']};document.querySelectorAll('.blog-post').forEach(p=>{const content=p.querySelector('.post-content').textContent.toLowerCase();let show=false;if(m[c]){show=m[c].some(word=>content.includes(word))}p.style.display=show?'block':'none'})}

function scrollToStory(id){const p=document.querySelector(`[data-id="${id}"]`);if(p)p.scrollIntoView({behavior:'smooth',block:'start'})}

function initAuth(){const saved=localStorage.getItem("skogsmulle_user");if(saved){const user=JSON.parse(saved);if(user.email==='tomas.roosguerra@gmail.com'||user.email==='tomasroosguerra@gmail.com'){isAdmin=true;currentUser=user;showAuthorTools()}else{showLoginSection()}}else{showLoginSection()}}

function updateDiscreteLogin(l){const b=document.querySelector('.discrete-login');b.textContent=l?'üë§ '+currentUser.email.split('@')[0]:'üîë Logga in';b.style.background=l?'linear-gradient(135deg,rgba(255,215,0,0.8),rgba(255,165,0,0.7))':'linear-gradient(135deg,rgba(144,238,144,0.9),rgba(135,206,235,0.7))'}

function toggleLoginModal(){document.getElementById('loginModal').style.display='flex'}

function closeLoginModal(){document.getElementById('loginModal').style.display='none'}

function showAuthorTools(){document.getElementById('newPostForm').style.display='block';document.getElementById('userInfo').style.display='block';document.getElementById('loginSection').style.display='none';document.getElementById('userEmail').textContent=currentUser.email;updateDiscreteLogin(true)}

function hideAuthorTools(){document.getElementById('newPostForm').style.display='none';document.getElementById('userInfo').style.display='none';document.getElementById('loginSection').style.display='block';updateDiscreteLogin(false)}

function signInWithGoogle(e){const email=e.toLowerCase().trim();if(email==='tomas.roosguerra@gmail.com'||email==='tomasroosguerra@gmail.com'){isAdmin=true;currentUser={email:email,name:email.split('@')[0]};localStorage.setItem("skogsmulle_user",JSON.stringify(currentUser));showAuthorTools();closeLoginModal();alert("V√§lkommen tillbaka, f√∂rfattare!")}else{isAdmin=false;currentUser=null;alert("Endast f√∂rfattaren kan logga in h√§r.")}}

function signOut(){isAdmin=false;currentUser=null;localStorage.removeItem("skogsmulle_user");hideAuthorTools();alert("Du har loggats ut.")}

function scrollToStories(){document.querySelector('.blog-section').scrollIntoView({behavior:'smooth',block:'start'})}

function scrollToAdventures(){document.querySelector('.blog-section').scrollIntoView({behavior:'smooth',block:'start'})}

function showCharacterInfo(c){const info={skogsmulle:{name:"Skogsmulle",description:"En nyfiken och modig liten skogsman som √§lskar att utforska naturen och tr√§ffa nya v√§nner."},morris:{name:"Morris",description:"En klok och sn√§ll gr√§vling som alltid vet vad man ska g√∂ra n√§r man √§r i skogen."},evert:{name:"Evert",description:"En gladlynt och hj√§lpsam igelkott som √§lskar att samla b√§r och hj√§lpa sina v√§nner."},ron:{name:"Ron",description:"En slug och v√§nlig r√§v som kan hitta v√§gen genom de mest komplicerade skogspassagerna."}};const char=info[c];if(char){alert(`${char.name}\n\n${char.description}`)}}

document.getElementById("newPostForm").addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("postTitle").value.trim();const c=document.getElementById("postContent").value.trim();if(!t||!c){alert("V√§nligen fyll i b√•de titel och ber√§ttelse.");return}const today=new Date();const ds=today.getDate()+" "+["Jan","Feb","Mar","Apr","Maj","Jun","Jul","Aug","Sep","Okt","Nov","Dec"][today.getMonth()]+", "+today.getFullYear();const np={title:t,content:`<p>${c.replace(/\n/g,"</p><p>")}</p>`,date:ds,timestamp:Date.now()};try{const pid=await C.save(np);if(pid){this.reset();alert("Ber√§ttelsen har publicerats!");setTimeout(()=>scrollToPost(0),100)}}catch(e){console.error("Publish error:",e);alert("Ett fel uppstod n√§r ber√§ttelsen skulle publiceras. F√∂rs√∂k igen.")}});

document.getElementById("loginForm").addEventListener("submit",function(e){e.preventDefault();const email=document.getElementById("emailInput").value;signInWithGoogle(email)});

document.getElementById('loginModal').addEventListener('click',function(e){if(e.target===this)closeLoginModal()});

themeAudio.addEventListener("ended",()=>document.getElementById("playTheme").textContent="üéµ Spela temal√•t");
adventureAudio.addEventListener("ended",()=>document.getElementById("playAdventure").textContent="üé∂ Spela √§ventyrsl√•t");

function toggleThemeAudio(){const b=document.getElementById("playTheme");if(themeAudio.paused){themeAudio.play();b.textContent="‚è∏Ô∏è Pausa"}else{themeAudio.pause();b.textContent="üéµ Spela temal√•t"}}

function toggleAdventureAudio(){const b=document.getElementById("playAdventure");if(adventureAudio.paused){adventureAudio.play();b.textContent="‚è∏Ô∏è Pausa"}else{adventureAudio.pause();b.textContent="üé∂ Spela √§ventyrsl√•t"}}

document.addEventListener("DOMContentLoaded",function(){console.log("Initializing Skogsmulle application...");initAuth();setTimeout(()=>{if(window.firebaseDb){console.log("Firebase initialized, setting up real-time listener");setupRealtimeListener()}else{console.log("Firebase not available, falling back to empty state");allPosts=[];renderAllPosts();updateRecentStories()}},1000)});
</script>
</body>
</html>
